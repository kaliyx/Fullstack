<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="assets/image.css">
    <link rel="stylesheet" href="assets/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    
    <title>Mis Compras - HUERTO HOGAR</title>
</head>

<body>
    <!-- NAVBAR -->
    <header>
        <nav class="navbar custom-navbar">
            <div class="d-flex w-100 align-items-center">
                <!-- Título principal -->
                <span class="custom-title me-4">
                    <img src="assets/picture/logo.jpg" alt="Logo Hogar" class="navbar-logo me-2">
                    HUERTO HOGAR
                </span>
                <!-- Links -->
                <div class="d-flex ms-2">
                    <a class="nav-link" href="home.html">Home</a>
                    <div class="dropdown productos-dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="productosDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Productos
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="productosDropdown">
                            <li><a class="dropdown-item" href="./categorias/FrutasFrescas.html">Frutas Frescas</a></li>
                            <li><a class="dropdown-item" href="./categorias/VerdurasOrganicas.html">Verduras Orgánicas</a></li>
                            <li><a class="dropdown-item" href="./categorias/ProductosOrganicos.html">Productos Orgánicos</a></li>
                            <li><a class="dropdown-item" href="./categorias/ProductosLacteos.html">Productos Lácteos</a></li>
                        </ul>
                    </div>
                    <!-- Auth-protected links -->
                    <div id="authenticated-nav" class="d-none">
                        <a class="nav-link" href="perfil.html">Perfil</a>
                        <a class="nav-link active" href="MisCompras.html">Mis Compras</a>
                    </div>
                </div>
                <div class="flex-grow-1"></div>
                <div class="d-flex align-items-center">
                    <!-- Auth section -->
                    <div id="auth-section">
                        <a class="nav-link me-3" href="login.html" id="btn-login">Ingresar</a>
                        <a class="nav-link" href="registro.html" id="btn-register">Registro</a>
                    </div>
                    <div id="user-section" class="d-none">
                        <a class="nav-link me-3" href="#" id="btn-logout">Cerrar Sesión</a>
                    </div>
                    
                    <!-- Carrito -->
                    <a class="carrito-icon ms-4 position-relative" href="carrito.html" aria-label="Ver carrito">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-cart2" viewBox="0 0 16 16">
                            <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5M3.14 5l1.25 5h8.22l1.25-5zM5 13a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0"/>
                        </svg>
                        <span id="cartBadge" class="carrito-badge js-cart-count d-none">0</span>
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <!-- MAIN CONTENT -->
    <main class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="page-title mb-4">Mis Compras</h1>
                
                <!-- Loading state -->
                <div id="loading" class="d-flex justify-content-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>

                <!-- Error state -->
                <div id="error-message" class="alert alert-danger d-none" role="alert">
                    <h4 class="alert-heading">Error</h4>
                    <p id="error-text">No se pudieron cargar las compras.</p>
                </div>

                <!-- Empty state -->
                <div id="empty-orders" class="text-center py-5 d-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-bag text-muted mb-3" viewBox="0 0 16 16">
                        <path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1m3.5 3v-.5A3.5 3.5 0 0 0 8 0a3.5 3.5 0 0 0-3.5 3.5V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1z"/>
                    </svg>
                    <h3 class="text-muted">No tienes compras aún</h3>
                    <p class="text-muted">Cuando realices tu primera compra, aparecerá aquí.</p>
                    <a href="home.html" class="btn btn-primary">Ir de compras</a>
                </div>

                <!-- Orders list -->
                <div id="orders-container" class="d-none">
                    <!-- Orders will be rendered here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="function.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Require authentication
            if (window.HHAuth && !window.HHAuth.requireAuth()) {
                return; // requireAuth will redirect if not authenticated
            }

            // Update navbar
            if (window.HHAuth) {
                window.HHAuth.updateNavbar();
            }

            loadOrders();

            async function loadOrders() {
                const loading = document.getElementById('loading');
                const errorMessage = document.getElementById('error-message');
                const errorText = document.getElementById('error-text');
                const emptyOrders = document.getElementById('empty-orders');
                const ordersContainer = document.getElementById('orders-container');

                try {
                    loading.classList.remove('d-none');
                    errorMessage.classList.add('d-none');
                    emptyOrders.classList.add('d-none');
                    ordersContainer.classList.add('d-none');

                    const response = await window.HHAuth.apiFetch('/api/orders');
                    const orders = await response.json();

                    loading.classList.add('d-none');

                    if (orders.length === 0) {
                        emptyOrders.classList.remove('d-none');
                        return;
                    }

                    renderOrders(orders);
                    ordersContainer.classList.remove('d-none');

                } catch (error) {
                    console.error('Error loading orders:', error);
                    loading.classList.add('d-none');
                    errorText.textContent = error.message || 'No se pudieron cargar las compras.';
                    errorMessage.classList.remove('d-none');
                }
            }

            function renderOrders(orders) {
                const container = document.getElementById('orders-container');
                container.innerHTML = '';

                orders.forEach((order, index) => {
                    const orderDate = new Date(order.created_at).toLocaleDateString('es-CL', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const orderCard = document.createElement('div');
                    orderCard.className = 'card mb-3';
                    orderCard.innerHTML = `
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Pedido #${order.id}</strong>
                                <small class="text-muted ms-2">${orderDate}</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-success me-3">${window.HHCart ? window.HHCart.formatCLP(order.total) : '$' + order.total.toLocaleString('es-CL')}</span>
                                <button class="btn btn-sm btn-outline-primary" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#order-${order.id}" 
                                        aria-expanded="false" aria-controls="order-${order.id}">
                                    <span class="collapse-text">Ver detalles</span>
                                    <svg width="16" height="16" fill="currentColor" class="bi bi-chevron-down ms-1" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="collapse" id="order-${order.id}">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">Productos</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Producto</th>
                                                <th>Precio</th>
                                                <th>Cantidad</th>
                                                <th>Subtotal</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${order.items.map(item => `
                                                <tr>
                                                    <td>${item.name}</td>
                                                    <td>${window.HHCart ? window.HHCart.formatCLP(item.price) : '$' + item.price.toLocaleString('es-CL')}</td>
                                                    <td>${item.qty}</td>
                                                    <td>${window.HHCart ? window.HHCart.formatCLP(item.price * item.qty) : '$' + (item.price * item.qty).toLocaleString('es-CL')}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                        <tfoot>
                                            <tr class="table-active">
                                                <th colspan="3">Total</th>
                                                <th>${window.HHCart ? window.HHCart.formatCLP(order.total) : '$' + order.total.toLocaleString('es-CL')}</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;

                    container.appendChild(orderCard);
                });

                // Add collapse event listeners to update button text
                container.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
                    const target = document.querySelector(button.getAttribute('data-bs-target'));
                    const collapseText = button.querySelector('.collapse-text');
                    const chevron = button.querySelector('.bi-chevron-down');

                    target.addEventListener('show.bs.collapse', () => {
                        collapseText.textContent = 'Ocultar detalles';
                        chevron.style.transform = 'rotate(180deg)';
                    });

                    target.addEventListener('hide.bs.collapse', () => {
                        collapseText.textContent = 'Ver detalles';
                        chevron.style.transform = 'rotate(0deg)';
                    });
                });
            }
        });
    </script>
</body>
</html>